name: build
description: Build the wiki

runs:
  using: 'composite'
  steps:
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - name: Allow modern Yarn
      run: |
        corepack enable
      shell: bash
    # Dependencies manually cached because `actions/setup-node@v3` does not support corepack
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          .yarn/cache
        key: wiki-dependencies-${{ hashFiles('yarn.lock') }}
        restore-keys: |
          wiki-dependencies
    - name: Install dependencies
      run: |
        yarn
      shell: bash
    - name: Build plugins
      run: |
        yarn build:plugins
      shell: bash
    - name: Build theme
      run: |
        yarn build:theme
      shell: bash
    - name: Generate APIs
      run: |
        yarn generate:api
      shell: bash
    # Artifacts cached after install to prevent removal by Yarn
    - name: Cache build artifacts
      uses: actions/cache@v3
      with:
        path: node_modules/.cache
        key: wiki-build-artifacts-${{ hashFiles('package.json', 'yarn.lock', 'src/**/*.*') }}
    # Create reference docs
    - name: Build reference docs
      run: |
        ./scripts/gen_sdk_references.sh
      shell: bash
    - name: Build
      run: |
        yarn build
      # Avoid running out of memory
      env:
        NODE_OPTIONS: '--max-old-space-size=2048'
      shell: bash
